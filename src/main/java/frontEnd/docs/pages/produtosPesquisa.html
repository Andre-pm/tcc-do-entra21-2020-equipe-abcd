<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/produtoPesquisa.css">
    <title>Document</title>
</head>
<body>
   <section id="idSection"></section>

    <Script>
        let arrayProdutos = [];

        //recebe o nome do produto pesquisado
        let nomeproduto = localStorage.getItem("ProdutoPesquisa");
        criaDivsProdutos()


        function criaDivsProdutos(){
            const xhrGetProdutos = new XMLHttpRequest;
            xhrGetProdutos.open("GET", "http://localhost:8081/api/catalogo/busca/nome/"+nomeproduto);
            xhrGetProdutos.addEventListener("load", function () {
                let produtos = xhrGetProdutos.responseText;
                produtos = JSON.parse(produtos);
                // receeb o cep do cliente
                var cepCliente = localStorage.getItem("UsuarioCep");

                // recebe a instância
                const xhrGetCepCli = new XMLHttpRequest;

                //-------------- chama outra API, que retorna a localização --------------------------

                xhrGetCepCli.open("GET", "http://viacep.com.br/ws/"+cepCliente+"/json/");

                xhrGetCepCli.addEventListener("load", function () {
                    //localização
                    var resposta = xhrGetCepCli.responseText;
                    var enderecoCliente = JSON.parse(resposta);
                   

                    //--------------- api que converte localidade em Latitude e Longitude ----------------
                    const xhr = new XMLHttpRequest;
                    xhr.open("GET", "https://nominatim.openstreetmap.org/?addressdetails=1&q="+enderecoCliente.logradouro+"+"+enderecoCliente.bairro+"+"+enderecoCliente.localidade+"&format=json&limit=1");
                    xhr.addEventListener("load", function () {
                            let resposta = xhr.responseText;
                            resposta = JSON.parse(resposta);
                            
                            let lat1 = resposta[0].lat;
                            let lon1 = resposta[0].lon;

                            //converte cep em endereço para cada produto
                            getEnderecoComercios(lat1, lon1);
                    });
                    xhr.send();  
                });
                xhrGetCepCli.send();    

                //-----------------------------------------------------------------------------------------------
                //-------------------------------- funções auxiliares -------------------------------------------
                //-----------------------------------------------------------------------------------------------

                function getEnderecoComercios (lat1, lon1){

                    for (let index = 0; index < produtos.length; index++) {
                        let cepComercio = produtos[index].comercio.cep;

                        const xhrGetCepComercio = new XMLHttpRequest;
                        xhrGetCepComercio.open("GET", "http://viacep.com.br/ws/"+cepComercio+"/json/");

                        xhrGetCepComercio.addEventListener("load", function () {
                            //localização
                            var resposta = xhrGetCepComercio.responseText;
                            var enderecoComercio = JSON.parse(resposta);
                        

                            //--------------- api que converte localidade em Latitude e Longitude ----------------
                            const xhr = new XMLHttpRequest;
                            xhr.open("GET", "https://nominatim.openstreetmap.org/?addressdetails=1&q="+enderecoComercio.logradouro+"+"+enderecoComercio.bairro+"+"+enderecoComercio.localidade+"&format=json&limit=1");
                            xhr.addEventListener("load", function () {
                                    let resposta = xhr.responseText;
                                    resposta = JSON.parse(resposta);
                                    
                                    let lat2 = resposta[0].lat;
                                    let lon2 = resposta[0].lon;

                                    //calcula a distância entre os dois pontos
                                    let distancia = calcDistancia(lat1, lon1, lat2, lon2);

                                    infoProduto = {
                                        categoria : produtos[index].categoria,
                                        nomeDescritivo : produtos[index].nomeDescritivo,
                                        preco : produtos[index].preco,
                                        cep : produtos[index].comercio.cep,
                                        nomeComercio : produtos[index].comercio.nomeFantasia,
                                        distancia : distancia
                                    }
                                    //adiciona o produto ao array
                                    arrayProdutos.push(infoProduto);

                                    if (arrayProdutos.length == produtos.length) {
                                        //organiza a lista por melhor opção
                                        arrayProdutos = organizaProdutos(arrayProdutos);
                                        //cria as divs
                                        divsProdutos(arrayProdutos);
                                        console.log(arrayProdutos);
                                    }
                            });
                            xhr.send();  
                        });
                        xhrGetCepComercio.send();   


                    }

                }

                
            
            });
            xhrGetProdutos.send();
        }


        //método que calcula a distância
        function calcDistancia(lat1, lon1, lat2, lon2){
            let el1 = 0;
            let el2 = 0;

            let R = 6371; // Radius of the earth

            let latDistance = degrees_to_radians(lat2 - lat1);
            let lonDistance = degrees_to_radians(lon2 - lon1);
            let a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)
                    + Math.cos(degrees_to_radians(lat1)) * Math.cos(degrees_to_radians(lat2))
                    * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            let distance = R * c * 1000; // convert to meters

            let height = el1 - el2;

            distance = Math.pow(distance, 2);
            distanciaTotal =(((Math.sqrt(distance))/1000)).toFixed(2);
            if (distanciaTotal == 0){
                return 1.1;
            }

            return distanciaTotal;
        }

        //Calcula o radiance (pois o js não tem o método que faz isso automaticamente como no java)
        function degrees_to_radians(degrees){
            var pi = Math.PI;
            return degrees * (pi/180);
        }

        //Cria as divs dos produtos
        function divsProdutos(arrayProdutos){
            console.log(arrayProdutos.length);
            for (let index = 0; index < arrayProdutos.length; index++) {
                let newDiv = document.createElement('div');
                newDiv.className = 'divs';
                newDiv.textContent = arrayProdutos[index].categoria+" | "+arrayProdutos[index].nomeDescritivo+" | "+arrayProdutos[index].preco+" | Comércio: "+ arrayProdutos[index].nomeComercio+"| Distãncia aproximada: "+ arrayProdutos[index].distancia +" Km";
                document.getElementById('idSection').appendChild(newDiv);
            }
        }

        //organiza os produtos por melhor opção dentro do array 
        function organizaProdutos(arrayProdutos){
            
                let temp;
                let mLista = 0;

                for(let j = 0; j < arrayProdutos.length; j++) {
                    for(let i = 0; i < arrayProdutos.length-1; i++) {
                        // -------------- + + fórmula mágica + +-----------------------
                        let soma1 = Number( arrayProdutos[i].preco) + Number(arrayProdutos[i].distancia);
                        let soma2 = arrayProdutos[i+1].preco + arrayProdutos[i+1].distancia;
                        console.log('preco: '+arrayProdutos[i].preco);
                        console.log('distancia: '+arrayProdutos[i].distancia);
                        console.log('soma: '+soma1);
                        console.log('----------');

                        if (soma1 > soma2) {
                            temp = arrayProdutos[i];
                            arrayProdutos[i] = arrayProdutos[i+1];
                            arrayProdutos[i+1] = temp;
                        }
                    }
                }
        
                return arrayProdutos;
        }

    </Script>
</body>
</html>