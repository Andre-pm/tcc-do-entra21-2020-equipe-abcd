<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href='https://css.gg/menu.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/categorias.css">
    <title>Mercados</title>
</head>
<body>
    <header>
        <div class="barraPesquisa">
            <h2 id="tituloBarra">Pesquisa</h2>
            <div id="pesquisaSpace">
                <img id="search" src="../assets/search.png">
                <input id="inputPesquisa" type="text" name="Buscar" id="idBuscar" placeholder="O que você precisa?">
            </div>
            <div class="topnav">
                <div class="active">
                    <div id="myLinks">
                        <a href="../pages/home.html">Home</a>
                    </div>
                    <a href="javascript:void(0);" class="icon" onclick="menu()">
                        <i class="gg-menu"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>
    <main>
        <table id="selecao">
            
        </table>
    </main>
<script src="../js/menu.js"></script>

<!-- ----------------------Script abaixo ------------------------------>
<Script>
     let arrayProdutos = [];

    //realiza as busca ao precionar enter
    document.getElementById('inputPesquisa').addEventListener('keyup', function(e){
            var key = e.which || e.keyCode;
            //abre a nova tela ao precionar enter
            if (key == 13) { // codigo da tecla enter
                localStorage.setItem("ProdutoPesquisa", document.getElementById('inputPesquisa').value);
                window.location.href = "pesquisaProdutos.html";
            }
    });       
   

    //recebe o nome do produto pesquisado
    let nomeproduto = localStorage.getItem("ProdutoPesquisa");
    criaDivsProdutos()


    function criaDivsProdutos(){
        const xhrGetProdutos = new XMLHttpRequest;
        xhrGetProdutos.open("GET", "http://localhost:8081/api/catalogo/busca/nome/"+nomeproduto);
        xhrGetProdutos.addEventListener("load", function () {
            let produtos = xhrGetProdutos.responseText;
            produtos = JSON.parse(produtos);

            if (produtos.length == 0) {
                alert('Produto não encontrado');
            }
            else{
                
                getEnderecoComercios(produtos);  

            }
            

            //-----------------------------------------------------------------------------------------------
            //-------------------------------- funções auxiliares -------------------------------------------
            //-----------------------------------------------------------------------------------------------

            function getEnderecoComercios (produtos){

                for (let index = 0; index < produtos.length; index++) {
                    let cepComercio = produtos[index].comercio.cep;
    
                        
                                let infoProduto = {
                                    id : produtos[index].comercio.comercioId,
                                    categoria : produtos[index].categoria,
                                    nomeDescritivo : produtos[index].nomeDescritivo,
                                    preco : produtos[index].preco,
                                    cep : produtos[index].comercio.cep,
                                    nomeComercio : produtos[index].comercio.nomeFantasia,
                                    logradouro : produtos[index].comercio.logradouro,
                                    bairro : produtos[index].comercio.bairro
                                }
                                //adiciona o produto ao array
                                arrayProdutos.push(infoProduto);

                                if (arrayProdutos.length == produtos.length) {
                                   
                                    //organiza a lista por melhor opção
                                    arrayProdutos = organizaProdutos(arrayProdutos);
                                    //cria as divs
                                    divsProdutos(arrayProdutos);
                                    console.log(arrayProdutos);
                                }
                         
                    


                }

            }

            
        
        });
        xhrGetProdutos.send();
    }

    

    //Cria as divs dos produtos
    function divsProdutos(arrayProdutos){
        console.log(arrayProdutos.length);
        for (let index = 0; index < arrayProdutos.length; index++) {
            let newTr = document.createElement('tr');
            let newTd = document.createElement('td');
            let newDiv = document.createElement('div');
            let newDivGeral = document.createElement('div');
            let newH2NomePreco = document.createElement('h2'); 
            let newH2MercadoDistancia = document.createElement('h2'); 
            newTd.id = arrayProdutos[index].id;
            newTd.className = 'loja';
            newDiv.id = 'logoLoja';
            newDivGeral.id = 'divGeral';
            newH2NomePreco.className = 'NomePreco';

            newH2NomePreco.textContent = arrayProdutos[index].nomeDescritivo+" | R$ "+arrayProdutos[index].preco;
            newH2MercadoDistancia.textContent = arrayProdutos[index].nomeComercio+"  |  Endereço: "+ arrayProdutos[index].bairro +", "+arrayProdutos[index].logradouro;
            newDivGeral.appendChild(newH2NomePreco);
            newDivGeral.appendChild(newH2MercadoDistancia);
            newTd.appendChild(newDiv);
            newTd.appendChild(newDivGeral);
            newTr.appendChild(newTd);
           
            document.getElementById('selecao').appendChild(newTr);
        }
    }

    //organiza os produtos por melhor opção dentro do array
    function organizaProdutos(arrayProdutos){
        
            let temp;

            for(let j = 0; j < arrayProdutos.length; j++) {
                for(let i = 0; i < arrayProdutos.length-1; i++) {
                    // -------------- + + fórmula mágica + +-----------------------
                    let soma1 = Number( arrayProdutos[i].preco);
                    let soma2 =Number(arrayProdutos[i+1].preco);

                    if (soma1 > soma2) {
                        temp = arrayProdutos[i];
                        arrayProdutos[i] = arrayProdutos[i+1];
                        arrayProdutos[i+1] = temp;
                    }
                }
            }
    
            return arrayProdutos;
    }

</Script>
<script src="../js/criarPerfilLoja.js"></script>
</body>
</html>